
# Curve & Surface Point Inversion — 알고리즘 정리

이 문서는 **곡선/곡면에 대한 최근접 점(파라미터) 역매핑**을 위한 핵심 수식과 실전 튜닝 포인트만 정리합니다.  

---

## 0. 표기

- 대상 점: **P** ∈ ℝ³  
- 곡선: **C(u)**, 도메인 `u ∈ [u_min, u_max]` (혹은 주기적)  
- 곡면: **S(u, v)**, 도메인 `u ∈ [u_min, u_max]`, `v ∈ [v_min, v_max]` (혹은 주기적)  
- 잔차(residual): **r(u)** = C(u) − P, **r(u,v)** = S(u,v) − P  
- 1차/2차 미분: C′, C″ / S_u, S_v, S_uu, S_uv, S_vv  
- 내적: a·b, 벡터 크기: ‖a‖

목표는 **거리 최소화**:
- 곡선:  $\(\min_u \, \frac{1}{2}\|C(u)-P\|^2\)$
- 곡면:  $\(\min_{u,v} \, \frac{1}{2}\|S(u,v)-P\|^2\)$

---

## 1) 곡선 Point Inversion

### 1.1 뉴턴-랩슨(Newton) 갱신식
에너지 $\(E(u)=\frac{1}{2}\|r(u)\|^2\)$,  
그레디언트 $\(g(u)=\frac{dE}{du}=r\cdot C'(u)\)$  
헤시안 근사 $\(h(u)=\frac{d^2E}{du^2} = C'(u)\cdot C'(u) + r\cdot C''(u)\)$

$$
u_{k+1} = u_k - \frac{g(u_k)}{h(u_k)}
= u_k - \frac{ r\cdot C'(u_k) }{  \|C'(u_k)\|^2 + r\cdot C''(u_k)  }.
$$

- 분모가 아주 작거나 부호가 불안정하면 **스텝 축소/백트래킹** 또는 **LM(아래)** 사용.

### 1.2 가우스-뉴턴(Gauss–Newton, GN)
헤시안을 완전 계산하지 않고 2차 항을 버린 근사:
$u_{k+1} = u_k - \frac{ r\cdot C' }{ \|C'\|^2 }.$
- 곡률이 강하거나 P가 멀리 있으면 수렴성이 떨어질 수 있음.

### 1.3 레벤버그–마쿼르트(Levenberg–Marquardt, LM)
뉴턴/ GN의 불안정성을 막기 위해 정규화 λ를 도입:
$( \|C'\|^2 + \lambda ) \, \Delta u = - r\cdot C', \quad u_{k+1} = u_k + \Delta u.$
- λ는 **작아지면 뉴턴/GN**, **커지면 경사하강**에 가까움.
- 수용 여부에 따라 λ를 줄이거나(성공) 늘림(거절).

### 1.4 실전 팁 (곡선)
- **도메인 처리**: 비주기 곡선은 `clamp`(경계 바깥 금지), 주기 곡선은 **wrap**.  
- **트러스트-레디우스**: 3D 예측 이동 ‖Δu·C′‖을 상한으로 제한.  
- **초기치**: 도메인에서 **coarse sampling**으로 거리 최소 u를 시드.  
- **종료**: (i) ‖r‖² < tol_f², (ii) |r·C′| < tol_g, (iii) |Δu| 또는 ‖Δu·C′‖가 작음.  
- **직교성 체크(옵션)**: $\(|\hat r\cdot \hat C'| \ll 1\)$ 이면 곡선에 거의 수직으로 투영됨.

---

## 2) 곡면 Point Inversion

### 2.1 정식화
$\(E(u,v)=\frac{1}{2}\|r(u,v)\|^2\)$, $\(r=S(u,v)-P\)$.  
자코비안 $\(J=[S_u\; S_v]\in\mathbb{R}^{3\times 2}\)$,  
그레디언트 $\(g = J^T r = \begin{bmatrix} S_u\cdot r \\ S_v\cdot r \end{bmatrix}\)$.

### 2.2 뉴턴(Full Newton) / 유사-헤시안
$$
H \;=\;
\begin{bmatrix}
S_u\cdot S_u + r\cdot S_{uu} & S_u\cdot S_v + r\cdot S_{uv} \\[2pt]
S_u\cdot S_v + r\cdot S_{uv} & S_v\cdot S_v + r\cdot S_{vv}
\end{bmatrix},\quad
H\,\begin{bmatrix}\Delta u\\ \Delta v\end{bmatrix} \;=\; -g.
$$

- 2차 미분까지 쓰므로 빠를 수 있으나, **극/퇴화**에서 불안정.

### 2.3 가우스-뉴턴(GN)
헤시안의 2차 잔차항을 생략:
$$
(J^T J)\,\Delta = -g, \qquad
J^T J =
\begin{bmatrix}
S_u\cdot S_u & S_u\cdot S_v \\[2pt]
S_u\cdot S_v & S_v\cdot S_v
\end{bmatrix}.
$$

- 안정적이지만, 강한 비선형/초기치가 나쁠 때는 느릴 수 있음.

### 2.4 레벤버그–마쿼르트(LM)
$$
\big(J^T J + \lambda I\big)\,\Delta = -g,\qquad
(u,v)_{k+1}=(u,v)_k+\Delta.
$$
- **신뢰영역(Trust-Region) 해석**과 유사.  
- 실제 감소 대 예측 감소의 비율 $\( \rho = \frac{\Delta E_\text{actual}}{\Delta E_\text{pred}} \)$ 로 **λ 조정**:
  - ρ 높음 → λ ↓ (모델 신뢰 ↑)
  - ρ 낮음 → λ ↑ (보수적으로)

### 2.5 열 스케일 정규화 (Conditioning 개선)
S_u, S_v의 노름으로 J의 열을 정규화(비등방 스케일):
- $\( \tilde S_u = S_u / \|S_u\|, \ \tilde S_v = S_v / \|S_v\|\)$ 
- 정규화된 시스템에서 Δ를 구한 뒤 원래 변수로 복원.  
- 단위/스케일 차이가 큰 곡면에서 수렴성 개선 효과가 큼.

### 2.6 트러스트-레디우스
3D 예측 이동량을 제한:
$$
\|\Delta u\,S_u + \Delta v\,S_v\| \le \tau
$$
- $\(\tau\)$는 문제 스케일에 맞춰 설정(예: 0.25~1.0).

### 2.7 도메인/시임/극 처리
- **비주기**: 파라미터를 도메인에 `clamp`.  
- **주기(닫힘)**: u, v 각각 **wrap**.  
- **시임(seam) 후보 동시 평가**: (0,±U)×(0,±V) 총 9개 후보의 함수값을 비교해 **최소** 선택.  
- **극/퇴화 가드**: $\(\|S_u \times S_v\|\)$가 아주 작으면(≈0) 헤시안이 병든 상태 → λ를 일시적으로 크게, trust 반경은 작게.

### 2.8 보조 전략
- **시드(초기치)**: 도메인에서 coarse grid(예: 7×7)로 최소 거리 후보 선택 → **micro-grid(3×3)** 재탐색으로 미세 보정.  
- **백트래킹/라인서치**: 모델 예측 대비 실제 감소가 나쁘면 스텝 축소.  
- **Iso-curve 1D 폴백**: 2D 스텝이 거절되면 `u` 고정, `v` 고정 각각 1D 뉴턴 스텝을 1–2회 적용 후 다시 2D로 복귀.  
- **멀티 시드(선택)**: 난해한 경우, 여러 시드를 병렬 시도 후 최선 택일.

### 2.9 종료 조건(예시)
- 잔차: ‖r‖² < tol_f² (예: 1e−22)  
- 그레디언트: ‖g‖² < tol_g² (예: 1e−26)  
- 스텝: ‖Δu·S_u + Δv·S_v‖ < tol_step  
- 반복 상한: k ≤ k_max

### 2.10 투영 판정(옵션)
최근접 투영으로서의 직교성:
- $\(|S_u \cdot \hat r| \ll 1,\; |S_v \cdot \hat r| \ll 1\)$  ( $\(\hat r=r/\|r\|\)$ )

---

## 3) Trimmed Surface에의 적용

1. **기초 역매핑**: (u, v) 추정치를 위 절차로 얻음.  
2. **트림 테스트**: 얻은 (u, v)이 트림 곡선 다각형/정확 판정에 **inside**인지 검사.  
3. **밖인 경우**:  
   - 가장 가까운 트림 에지(파라메트릭 곡선)에 대해 1D **curve inversion**으로 (u, v)을 **에지에 투영**.  
   - 필요 시 서피스 역매핑으로 **폴리시(polish)**.

---

## 4) 권장 파라미터(경험값 예시)

- 곡선 LM λ 초기값: 1e−6 (성공 시 ×0.25, 실패 시 ×4, 범위 [1e−12, 1e8])  
- 곡면 LM λ 초기값: 1e−6, 위와 동일한 스케줄  
- 트러스트-레디우스(3D): 곡선 1.0 전후, 곡면 0.25–0.5 전후  
- 극 가드 임계: $\(\|S_u \times S_v\| < 1e−14\)$ 부근에서 λ 임시 증폭, trust 축소  
- 시드: 7×7 coarse + ±10% micro, 정체 시 ±5% micro 재시드

---

## 5) 체크리스트

- [ ] 도메인/주기 처리(clamp/wrap) 분기 확실한가?  
- [ ] 시드가 NaN/Inf일 때 **자동 시딩**이 작동하는가?  
- [ ] 시임(±period) 후보를 **실제 함수값**으로 비교해 최솟값을 선택하는가?  
- [ ] 극/퇴화(‖S_u×S_v‖≈0)에서 λ 증폭/반경 축소가 작동하는가?  
- [ ] 스텝 수용시 λ↓, 거절시 λ↑ 로직이 안정적으로 동작하는가?  
- [ ] 종료 기준이 거리/그레디언트/스텝 모두를 커버하는가?  
- [ ] (선택) Iso-curve 1D 폴백이 켜져 있는가?

---

## 6) 기대 수치 범위(현 프로젝트 맥락)

- **곡선**: on-curve 케이스에서 ‖r‖ ≈ 1e−13 수준(머신 이플실론 근처)  
- **곡면 일반 패치**: on-surface는 1e−10~1e−7 내외, offset(≈1e−7) 케이스는 노이즈 스케일에 비례  
- **구/원통 시임·극**: 시드/시임/극 가드/스케일 정규화가 활성화되면 `dist` 유의한 하락

---

## 7) 요약

- **곡선**: Newton/GN/LM 중 **LM + trust-radius**가 가장 견고.  
- **곡면**: $\( (J^T J + \lambda I)\Delta=-g \)$ + **열 스케일 정규화**, **시임 전수 평가**, **극 가드**, **iso-curve 폴백**으로 **실사용 수준의 견고성** 확보.  
- Trimmed Surface는 역매핑 + 트림 테스트 + (필요 시) 에지 재투영/폴리시의 3단 구성으로 처리.

