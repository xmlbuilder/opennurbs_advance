
# Curve Fillet (Planar NURBS) — 수학·알고리즘 정리

본 문서는 OpenNURBS 기반 곡선-곡선 **필렛(원호) 생성** 코드를 분석하여, 핵심 수식과 알고리즘을 정리합니다.

---

## 1) 문제 정의

평면 상 두 곡선 $$\( \mathbf{c}_1(u), \mathbf{c}_2(s) \)$$ 에 대해 반지름 $$\(R\)$$ 의 원호 $$\(A\)$$ 가
- $$\( \mathbf{p}_1=\mathbf{c}_1(u^\*) \)$$ 와 $$\( \mathbf{p}_2=\mathbf{c}_2(s^\*) \)$$ 에서 **접선 연속(G1)** 이고
- 원의 중심 $$\( \mathbf{C} \)$$ 에서 각각 **반지름 $$\(R\)$$ ** 를 가진다면
이를 **필렛**이라 합니다.

평면 단위 법선을 $$\(\mathbf{k}\)$$ 라 할 때, 단위 접선/법선은

$$
\mathbf{t}_i=\frac{\mathbf{c}_i'}{\|\mathbf{c}_i'\|},\qquad
\mathbf{n}_i=\mathbf{k}\times \mathbf{t}_i\quad (i=1,2).
$$

이때 중심 및 접점은

$$
\mathbf{C}=\mathbf{c}_1(u^\*)+R\,\mathbf{n}_1(u^\*)=\mathbf{c}_2(s^\*)+R\,\mathbf{n}_2(s^\*),\quad
\|\mathbf{p}_i-\mathbf{C}\|=R.
$$

즉 $$\((u,s)\)$$ 에 대한 **중심 일치** 비선형 방정식

$$
\mathbf{F}(u,s)=\underbrace{\mathbf{c}_1(u)-\mathbf{c}_2(s)}_{\Delta \mathbf{p}}+
R\underbrace{\big(\mathbf{n}_1(u)-\mathbf{n}_2(s)\big)}_{\Delta \mathbf{n}}=\mathbf{0}
$$

을 푸는 것이 핵심입니다.

---

## 2) 뉴턴 선형화 (코드와의 연결)

뉴턴 단계에서

$$
\mathbf{J}(u,s)
\begin{bmatrix}\Delta u\\ \Delta s\end{bmatrix}= -\mathbf{F}(u,s),\qquad
\mathbf{J}=\big[\partial \mathbf{F}/\partial u\ \ \partial \mathbf{F}/\partial s\big]
$$

이며

$$
\frac{\partial \mathbf{F}}{\partial u}=\mathbf{c}_1'(u)+R\,\mathbf{n}_1'(u),\qquad
\frac{\partial \mathbf{F}}{\partial s}=-(\mathbf{c}_2'(s)+R\,\mathbf{n}_2'(s)).
$$

$$\(\mathbf{n}_i=\mathbf{k}\times \mathbf{t}_i,\ \mathbf{t}_i=\frac{\mathbf{c}_i'}{\|\mathbf{c}_i'\|}\)$$ 이므로 $$\(\mathbf{n}_i'\)$$ 는 정규화 미분을 포함하여 수치 불안정이 생길 수 있습니다.  
제공된 구현은 다음과 같이 이를 **안정화**합니다.

- 접선은 정규화하되, 길이 스케일을 분리(`length1, length2`)하여 **스텝 스케일 조절**.
- 3차원에서 \(\mathbf{p}_2-\mathbf{p}_1\)의 3성분 + 보조 제약(4번째 행)으로 **4×2 최소자승(SVD)** 시스템을 풀어 \(\Delta u,\Delta s\)를 얻음.
- 보조 제약은 `binormalCross`를 통해 두 오프셋 방향의 일관성을 강제하여 평면 수치 불안정(회전 자유도)을 억제.

코드 상 대응:
- `ON_FindIntersectWithNewtonMethod(...)` 내
  - `pointA/B = c_i(\cdot) + R\,(\mathbf{k}\times \mathbf{t}_i)` (offset 점)
  - `adjTangentA/B` (곡률 보정 접선) 사용
  - `J = [[+t1, -t2],[extra]]`, `rhs = (p2 - p1, extraRHS)`
  - `ON_SolveLinearEquations` → **SVD**로 \(\Delta u,\Delta s\) 최소자승 해.

---

## 3) 전체 파이프라인

1. **평면성 확인** (`ON_HasPlanar`) 및 `planeNormal` 확정.
2. **세그먼트 프루닝**: bbox를 반지름만큼 팽창 후 겹침(`ON_DoOverlapOrTouch`)인 구간만 후보.
3. **뉴턴 반복**:
   - 초기치: 구간 중간 파라미터.
   - 반복: 평가 → 오프셋 적용 → 오차/야코비안 → SVD 스텝 → 래핑/클램프 → 수렴 검사.
4. **원호 구성**: \(\mathbf{C},\mathbf{p}_1,\mathbf{p}_2\)로 `ON_ArcCurve` 생성.
5. **트림**: 접선 내적을 통해 원호 방향을 판정하고 `Trim` 수행(옵션).

---

## 4) 수식 정리 (평면 버전)

- **중심 일치식**

$$
\mathbf{F}(u,s)=\mathbf{c}_1(u)-\mathbf{c}_2(s)+R\big(\mathbf{n}_1(u)-\mathbf{n}_2(s)\big)=\mathbf{0}.
$$

- **뉴턴 시스템**

$$
\Big[\mathbf{c}_1'+R\mathbf{n}_1'\ \ -(\mathbf{c}_2'+R\mathbf{n}_2')\Big]
\begin{bmatrix}\Delta u\\ \Delta s\end{bmatrix}=-\mathbf{F}.
$$

- **중심/원호**
$$
\mathbf{C}=\mathbf{c}_1(u)+R\mathbf{n}_1(u)=\mathbf{c}_2(s)+R\mathbf{n}_2(s),\quad
\text{Arc}(\mathbf{C};\,\mathbf{p}_1,\mathbf{p}_2).
$$

> 3D 데이터라도 동일 평면 안에 있으면 **평면 좌표계로 사전 변환**한 뒤 2D로 푸는 것이 가장 견고합니다.

---

## 5) 한계와 개선

- **초기값 민감도**: 현재는 도메인 중앙 시드 → 최근접점/탠젠트 각도 기반 시드를 권장.
- **닫힌 곡선 래핑**: 파라미터 랩 처리 포함이나, 복잡 곡선에서는 추가 보호 필요.
- **반지름/곡률 제약**: 너무 작은 R이나 큰 곡률에서는 해가 없거나 자가교차 발생.
- **라인서치/댐핑**: 뉴턴 스텝 실패 시 댐핑, Armijo 라인서치 적용을 권장.
- **평면 사전투영**: 수치 안정성 크게 향상.

---

## 6) 사용 스니펫

```cpp
ON_ArcCurve fillet;
bool ok = ON_Fillet(C1, C2, /*planeNormal=*/ON_3dVector::UnsetVector,
                    /*radius=*/R, /*flip1=*/false, /*flip2=*/false,
                    /*trim1=*/true, /*trim2=*/true, fillet);
```

- `planeNormal` 미지정 시 자동 판정.
- `flip1/flip2`로 곡선 진행방향 조정.
- 성공 시 `fillet`는 원호, 필요 시 C1/C2는 접점에서 트림.

---

## 7) 테스트 아이디어

- 직선–직선 L-코너 (기대해 존재, 중심/접점 해석값 비교)
- 직선–원호 (CAD 빈도 높음)
- 원호–원호 (동심/이심/접선형)
- 일반 NURBS (무작위 시드/반복 성공률, 공차 통계)
